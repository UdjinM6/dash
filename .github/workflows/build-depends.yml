name: Build depends

on:
  workflow_call:
    inputs:
      build-target:
        description: "Target name as defined by matrix.sh"
        required: true
        type: string
      container-path:
        description: "Path to built container at registry"
        required: true
        type: string
      host:
        description: "Target triplet"
        required: true
        type: string
    outputs:
      key:
        description: "Key needed for restoring depends cache"
        value: ${{ jobs.build-depends.restore.outputs.cache-primary-key }}

jobs:
  build-depends:
    name: Build depends
    runs-on: ubuntu-22.04
    container:
      image: ${{ inputs.container-path }}
      options: --user root
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Cache depends sources
        uses: actions/cache@v4
        with:
          path: |
            depends/sources
          key: depends-sources-${{ hashFiles('depends/packages/*') }}
          restore-keys: |
            depends-sources-${{ hashFiles('depends/packages/*') }}
            depends-sources-

      - name: Restore cached depends
        uses: actions/cache/restore@v4
        id: restore
        with:
          path: |
            depends/built
            depends/${{ inputs.host }}
          key: ${{ runner.os }}-depends-${{ inputs.build-target }}-${{ hashFiles('depends/packages/*') }}
          restore-keys: |
            ${{ runner.os }}-depends-${{ inputs.build-target }}-${{ hashFiles('depends/packages/*') }}
            ${{ runner.os }}-depends-${{ inputs.build-target }}

      - name: Build depends
        run: env HOST=${{ inputs.host }} make -j$(nproc) -C depends

      - name: Save depends cache
        uses: actions/cache/save@v4
        if: steps.restore.outputs.cache-hit != 'true'
        with:
          path: |
            depends/built
            depends/${{ inputs.host }}
          key: ${{ steps.restore.outputs.cache-primary-key }}
